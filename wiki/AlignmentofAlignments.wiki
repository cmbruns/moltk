#summary Details of how to align two alignments.

= Introduction =

Alignment of two alignments, each containing internal gaps, is more complex than aligning two sequences.

  * Sum-of-pairs score: the score of an alignment is the sum of the pairwise alignment scores between each pair of sequences in the alignment.
  * "Once a gap, always a gap": internal gaps within the two input alignments are unchanged in the output alignment.

= Details =

The problem of aligning two alignments optimally is NP-hard.  Therefore we will not do that.  But what we *can* do is ensure that the alignment score from our dynamic programming algorithm is the correct sum-of-pairs score for the resulting alignment.  So the score will be correct, even if it is not optimal.  This commitment to computing the correct score gives us some advantages:
  # The steps where heuristics are applied can be more obvious, and hopefully more encapsulated, than if we produced an approximately correct score.
  # The correct score permits sharper testing and debugging.

== How do we produce this correct sum-of-pairs score? ==

... by ensuring that our pairwise alignment scores, gap extension scores, and gap opening scores are each computed correctly during the dynamic programming recurrence.  The gap opening score will turn out to be the tricky one.  So lets handle gap opening first, to get it out of the way.

=== Gap opening score ===

This first example shows a single column indel between two alignments.  
  * '-' represents a preexisting gap
  * 'i' represents a new insertion gap
  * 'X' represents a non-gap residue
  * '{{{*}}}' highlights the column(s) where the main action occurs
  * '+' shows where a new gap opening score should be applied
  * '0' shows where a new gap opening score is unnecessary

{{{
 alignment 1 (sequences a-d):
     * 
a) XXiX
b) XXi-
c) X-iX
d) X-i-
     * 

 alignment 2 (sequences e-l):
     * 
e) XXXX
f) XXX-
g) X-XX
h) X-X-
i) XX-X
j) XX--
k) X--X
l) X---
     * 
}}}

In alignment1, only sequence 'a)' has a new gap.  So our gap opening penalty only applies to sequence 'a)' in alignment 1.

{{{
    a    b    c    d

  XXiX XXi- X-iX X-i-
e XXXX XXXX XXXX XXXX
    +    0    0    0 

  XXiX XXi- X-iX X-i-
f XXX- XXX- XXX- XXX-
    ?    ?    0    0 
}}}